<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Pastes - PasteBin Pro</title>
    <link rel="stylesheet" href="/public/style.css">
    <link rel="stylesheet" href="/public/motion-blur.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
        }
    }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0f;
            color: white;
            margin: 0;
            padding: 2rem;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
            z-index: 20;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #00f5ff, #7b42ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
        }

        /* ... existing styles ... */
    </style>
</head>

<body>
    <div id="loading-screen"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background: #000; display: flex; align-items: center; justify-content: center; pointer-events: none;">
        <div id="loading-info"
            style="color: rgba(255,255,255,0.5); font-family: 'Inter', sans-serif; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase;">
            Loading...</div>
    </div>

    <!-- Motion Blur Cursor Container -->
    <div id="motion-blur-container"></div>

    <!-- Audio Elements (Persistent) -->
    <audio id="bgAudio" loop preload="auto">
        <source src="/public/audio.flac" type="audio/flac">
        <source src="/public/song.flac" type="audio/flac">
        Your browser does not support the audio element.
    </audio>

    <div id="volumeControl" class="volume-control">
        <div id="volumeArrow" class="volume-arrow">
            <span>Turn up the volume</span>
            <svg width="40" height="20" viewBox="0 0 40 20" fill="none">
                <path d="M10 10l20 0m0 0l-5-5m5 5l-5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
        </div>
        <button id="imgVolumeBtn" class="btn-icon volume-btn" title="Toggle Volume">
            <!-- Muted Icon by default -->
            <svg id="iconMuted" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M11 5L6 9H2V15H6L11 19V5Z" />
                <line x1="23" y1="9" x2="17" y2="15" />
                <line x1="17" y1="9" x2="23" y2="15" />
            </svg>
            <!-- Sound Icon (hidden) -->
            <svg id="iconSound" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" style="display: none;">
                <path d="M11 5L6 9H2V15H6L11 19V5Z" />
                <path d="M19.07 4.93C20.98 6.84 20.98 9.95 19.07 11.85" />
                <path d="M15.54 8.46C16.47 9.39 16.47 10.91 15.54 11.84" />
            </svg>
        </button>
    </div>

    <!-- Main Container -->
    <div class="container">

        <!-- View: List -->
        <div id="listView">
            <header>
                <h1>Public Pastes</h1>
            </header>
            <div id="pasteList" class="paste-list">
                <p>Loading pastes...</p>
            </div>
        </div>

        <!-- View: Detail (Initially Hidden) -->
        <div id="detailView" style="display: none;">
            <header class="header">
                <div class="logo">
                    <div class="logo-icon">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                            <path
                                d="M8 4L24 4C26.2091 4 28 5.79086 28 8V24C28 26.2091 26.2091 28 24 28H8C5.79086 28 4 26.2091 4 24V8C4 5.79086 5.79086 4 8 4Z"
                                stroke="url(#gradient1)" stroke-width="2" />
                            <path d="M10 12H22M10 16H22M10 20H18" stroke="url(#gradient2)" stroke-width="2"
                                stroke-linecap="round" />
                            <defs>
                                <linearGradient id="gradient1" x1="4" y1="4" x2="28" y2="28">
                                    <stop stop-color="#00f5ff" />
                                    <stop offset="1" stop-color="#7b42ff" />
                                </linearGradient>
                                <linearGradient id="gradient2" x1="10" y1="12" x2="22" y2="20">
                                    <stop stop-color="#ff006e" />
                                    <stop offset="1" stop-color="#ffbe0b" />
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>PasteBin Pro</h1>
                        <span class="badge">Public View</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="backBtn" class="btn btn-secondary">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M10 19l-7-7m0 0l7-7m-7 7h18" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        Back
                    </button>
                    <button id="rawBtn" class="btn btn-glass">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <path d="M3 3H17M3 7H17M3 11H17M3 15H17" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                        Raw
                    </button>
                    <button id="copyBtn" class="btn btn-secondary">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                            <rect x="7" y="7" width="10" height="10" rx="2" stroke="currentColor" stroke-width="2" />
                            <path d="M13 3H5C3.89543 3 3 3.89543 3 5V13" stroke="currentColor" stroke-width="2" />
                        </svg>
                        Copy
                    </button>
                </div>
            </header>

            <main id="mainContent">
                <!-- Loading State -->
                <div id="detailLoading" class="state-container" style="display: none;">
                    <div class="loader"></div>
                    <p>Loading paste...</p>
                </div>

                <!-- Not Found / Error -->
                <div id="notFoundState" class="state-container" style="display: none;">
                    <h2>Paste Not Found</h2>
                    <p>This paste might not exist or has been deleted.</p>
                </div>

                <!-- Paste Content -->
                <div id="pasteView" style="display: none;">
                    <div class="paste-header">
                        <div class="paste-info">
                            <h2 id="pasteTitle">Loading...</h2>
                            <div class="paste-meta">
                                <span class="language-tag" id="pasteLanguage">plaintext</span>
                                <span class="meta-item" id="pasteViews">0 views</span>
                                <span class="meta-item" id="pasteDate">Just now</span>
                            </div>
                        </div>
                    </div>

                    <div class="code-container">
                        <div class="code-header">
                            <div class="code-title" id="codeTitle">code.txt</div>
                            <div class="code-actions">
                                <button id="toggleLineNumbers" class="code-action-btn" title="Toggle line numbers">
                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M2 4h2M2 8h2M2 12h2M6 4h8M6 8h8M6 12h8" stroke="currentColor"
                                            stroke-width="1.5" stroke-linecap="round" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <pre id="pasteContentContainer"><code id="pasteContent" class="hljs"></code></pre>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
    <script src="/public/motion-blur.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
        }
    }
    </script>
    <script type="module">
        import { initLoadingShader } from '/public/loading-shader.js';

        initLoadingShader('loading-screen');

        window.hideLoader = function () {
            const loader = document.getElementById('loading-screen');
            if (loader && !loader.classList.contains('fading')) {
                loader.classList.add('fading');
                loader.style.transition = 'opacity 1s ease';
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 1000);
            }
        };
        setTimeout(window.hideLoader, 2500);
    </script>

    <script src="/shared/api.js"></script>

    <!-- Unified App Logic -->
    <script>
        const audio = document.getElementById('bgAudio');
        const volBtn = document.getElementById('imgVolumeBtn');
        const iconMuted = document.getElementById('iconMuted');
        const iconSound = document.getElementById('iconSound');
        const arrow = document.getElementById('volumeArrow');

        let hasInteracted = false;
        audio.volume = 0.02;

        function tryPlayAudio() {
            if (!hasInteracted && audio.paused) {
                hasInteracted = true;
                audio.play().then(() => {
                    updateAudioIcon();
                    arrow.classList.add('visible');
                    setTimeout(() => arrow.classList.remove('visible'), 4000);
                }).catch(e => console.log("Audio play deferred", e));
            }
        }

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                hasInteracted = true;
            } else {
                audio.pause();
            }
            updateAudioIcon();
        }

        function updateAudioIcon() {
            if (!audio.paused) {
                iconMuted.style.display = 'none';
                iconSound.style.display = 'block';
                volBtn.classList.add('active-volume');
            } else {
                iconMuted.style.display = 'block';
                iconSound.style.display = 'none';
                volBtn.classList.remove('active-volume');
            }
        }

        volBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleAudio();
        });

        // Global listeners for first interaction
        ['click', 'keydown', 'touchstart'].forEach(evt =>
            document.addEventListener(evt, tryPlayAudio, { once: true })
        );

        // --- Routing & App Logic ---
        const storage = new PasteStorage();
        const listView = document.getElementById('listView');
        const detailView = document.getElementById('detailView');
        const pasteListContainer = document.getElementById('pasteList');

        // View Elements
        const detailLoading = document.getElementById('detailLoading');
        const notFoundState = document.getElementById('notFoundState');
        const pasteViewContent = document.getElementById('pasteView');
        const pasteTitle = document.getElementById('pasteTitle');
        const pasteLanguage = document.getElementById('pasteLanguage');
        const pasteViews = document.getElementById('pasteViews');
        const pasteDate = document.getElementById('pasteDate');
        const pasteContent = document.getElementById('pasteContent');
        const codeTitle = document.getElementById('codeTitle');
        const container = document.querySelector('.container');

        // Navigation
        window.addEventListener('popstate', handleRoute);
        document.addEventListener('DOMContentLoaded', handleRoute);

        function handleRoute() {
            const path = window.location.pathname;
            if (path.startsWith('/v/')) {
                const id = path.split('/')[2];
                showDetail(id);
            } else {
                showList();
            }
        }

        function navigateTo(path) {
            window.history.pushState({}, '', path);
            handleRoute();
        }

        document.getElementById('backBtn').addEventListener('click', () => {
            navigateTo('/');
        });

        // --- List View Logic ---
        async function loadPastes() {
            try {
                const res = await fetch('/api/pastes/public-list');
                const pastes = await res.json();

                if (pastes.length === 0) {
                    pasteListContainer.innerHTML = '<p>No public pastes found.</p>';
                    return;
                }

                const folders = {};
                const noFolder = [];

                pastes.forEach(p => {
                    if (p.folderName) {
                        if (!folders[p.folderName]) folders[p.folderName] = [];
                        folders[p.folderName].push(p);
                    } else {
                        noFolder.push(p);
                    }
                });

                let html = '';
                if (noFolder.length > 0) {
                    html += `<div class="folder-group">${noFolder.map(p => renderPasteItem(p)).join('')}</div>`;
                }
                for (const [name, items] of Object.entries(folders)) {
                    html += `
                        <details class="folder-group">
                            <summary class="folder-title">üìÅ ${name} <span class="folder-count">${items.length}</span></summary>
                            <div class="folder-items">${items.map(p => renderPasteItem(p)).join('')}</div>
                        </details>
                    `;
                }
                pasteListContainer.innerHTML = html;

                // Attach click handlers for SPA nav
                document.querySelectorAll('a.paste-item').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const href = link.getAttribute('href');
                        navigateTo(href);
                    });
                });

            } catch (e) {
                console.error(e);
                pasteListContainer.innerHTML = '<p>Error loading pastes.</p>';
            }
        }

        function renderPasteItem(p) {
            return `
                <a href="/v/${p.id}" class="paste-item">
                    <div>
                        <div class="paste-title">${p.hasPassword ? 'üîí ' : ''}${p.title || 'Untitled'}</div>
                        <div class="paste-meta">${new Date(p.createdAt).toLocaleDateString()}</div>
                    </div>
                    <div><span class="badge">${p.views} views</span></div>
                </a>
            `;
        }

        // --- Detail View Logic ---
        async function showDetail(id) {
            listView.style.display = 'none';
            detailView.style.display = 'block';
            container.style.maxWidth = '1200px'; // Wider for code view

            detailLoading.style.display = 'flex';
            notFoundState.style.display = 'none';
            pasteViewContent.style.display = 'none';

            try {
                const paste = await storage.getPaste(id);
                if (!paste) throw new Error('Not found');

                renderPasteDetail(paste);
                detailLoading.style.display = 'none';
                pasteViewContent.style.display = 'block';
            } catch (err) {
                if (err.message.includes('401')) {
                    const pwd = prompt('üîí Password required:');
                    if (pwd) {
                        try {
                            const p = await storage.getPaste(id, true, pwd);
                            renderPasteDetail(p);
                            detailLoading.style.display = 'none';
                            pasteViewContent.style.display = 'block';
                            return;
                        } catch {
                            alert('Incorrect password');
                        }
                    }
                }
                detailLoading.style.display = 'none';
                notFoundState.style.display = 'flex';
            }
        }

        function renderPasteDetail(paste) {
            pasteTitle.textContent = paste.title || 'Untitled';
            pasteLanguage.textContent = paste.language;
            pasteViews.textContent = `${paste.views} views`;
            pasteDate.textContent = new Date(paste.createdAt).toLocaleString();
            codeTitle.textContent = 'code.txt'; // Simplification

            // Syntax logic
            pasteContent.className = `hljs language-${paste.language}`;
            if (paste.language === 'markdown') {
                pasteContent.innerHTML = marked.parse(paste.content);
            } else {
                pasteContent.textContent = paste.content;
                hljs.highlightElement(pasteContent);
            }

            // Re-setup copy/raw handlers specifically for this paste if needed
            // (For brevity, assuming global handlers or re-attaching here)
            window.currentViewedPaste = paste; // Store for buttons
        }

        function showList() {
            detailView.style.display = 'none';
            listView.style.display = 'block';
            container.style.maxWidth = '900px';
            loadPastes(); // Refresh list to update view counts?
        }

        // Initial Load
        // handleRoute() is called by DOMContentLoaded

        // Button Handlers for Detail View
        document.getElementById('copyBtn').addEventListener('click', () => {
            if (window.currentViewedPaste) navigator.clipboard.writeText(window.currentViewedPaste.content);
        });
        document.getElementById('rawBtn').addEventListener('click', () => {
            if (window.currentViewedPaste) {
                const newWindow = window.open();
                newWindow.document.write(`<pre>${window.currentViewedPaste.content}</pre>`);
            }
        });

    </script>
</body>

</html>