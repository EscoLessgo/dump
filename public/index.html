<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enter | PasteBin Pro</title>
    <link rel="stylesheet" href="/public/style.css">
    <link rel="stylesheet" href="/public/motion-blur.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
        }
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/public/motion-blur.js"></script>
    <style>
        /* Carousel CSS */
        .gallery {
            position: absolute;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background: #050505;
        }

        .cards {
            position: absolute;
            width: 20rem;
            height: 28rem;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            perspective: 1000px;
            pointer-events: none;
            /* Let clicks pass to items? No, items need events */
        }

        .cards li {
            pointer-events: auto;
        }

        .cards li {
            list-style: none;
            padding: 2rem;
            margin: 0;
            width: 20rem;
            height: 28rem;
            text-align: left;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 1rem;
            /* Image with Dark Gradient Overlay */
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0.95) 100%), url('/public/card-bg.jpg');
            background-size: cover;
            background-position: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .cards li.private-card {
            /* Distinct Private Style */
            background: linear-gradient(160deg, rgba(40, 10, 20, 0.95) 0%, rgba(10, 5, 5, 0.98) 100%);
            border: 1px solid rgba(255, 0, 110, 0.5);
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.25), inset 0 0 20px rgba(255, 0, 110, 0.05);
        }

        .cards li:hover {
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
        }

        .cards li.private-card:hover {
            border-color: rgba(255, 0, 110, 0.8);
            box-shadow: 0 0 40px rgba(255, 0, 110, 0.4);
        }

        .cards li h3 {
            font-size: 1.5rem;
            margin: 0 0 1rem 0;
            color: #00f5ff;
            font-weight: 700;
            text-shadow: 0 0 15px rgba(0, 245, 255, 0.3);
        }

        .cards li.private-card h3 {
            color: #ff006e;
            text-shadow: 0 0 15px rgba(255, 0, 110, 0.3);
        }

        .card-meta {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 1rem;
            display: flex;
            gap: 10px;
        }

        .card-preview {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: #ccc;
            opacity: 0.8;
            overflow: hidden;
            white-space: pre-wrap;
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            pointer-events: none;
        }

        .actions {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            z-index: 100;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .drag-proxy {
            visibility: hidden;
            position: absolute;
        }

        /* Shared Styles from Viewer */
        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* ensure View Viewer hides initially */
        #view-viewer {
            display: none;
        }

        body {
            margin: 0;
            overflow: hidden;
            /* Main page is hidden */
            background: #050505;
            display: block;
            /* Changed from flex to block to allow full SPA layout */
            height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        /* Centered Entry View */
        #view-entry {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* ... original styles ... */
        /* Re-paste original styles but with adaptations? 
           Actually, the previous styles (lines 26-210) are still valid for the Entry components.
           I just need to ensure they don't conflict. 
        */

        .main-card {
            text-align: center;
            z-index: 10;
        }

        h1 {
            font-size: 4rem;
            margin-bottom: 3rem;
            background: linear-gradient(to right, #fff, #888);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            letter-spacing: -2px;
        }

        .button-container {
            display: flex;
            gap: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .entry-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 3rem;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            min-width: 200px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .entry-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .btn-public {
            border-color: rgba(0, 245, 255, 0.3);
        }

        .btn-public:hover {
            background: rgba(0, 245, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.2);
        }

        .btn-private {
            border-color: rgba(255, 0, 80, 0.3);
        }

        .btn-private:hover {
            background: rgba(255, 0, 80, 0.1);
            box-shadow: 0 0 30px rgba(255, 0, 80, 0.2);
        }

        .tech-hint {
            margin-top: 2rem;
            font-family: 'JetBrains Mono', monospace;
            color: #ff0050;
            font-size: 0.9rem;
            opacity: 0.8;
            cursor: pointer;
            position: relative;
            display: inline-block;
            z-index: 100;
            /* Force above overlays */
            pointer-events: auto;
            /* Ensure clickable */
        }

        .tech-hint::before {
            content: '> ';
            opacity: 0.5;
        }

        .tech-hint:hover {
            text-shadow: 0 0 8px #ff0050;
            opacity: 1;
        }

        .entry-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 3rem;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            min-width: 200px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            z-index: 100;
            /* Force above overlays */
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            /* Darker background since blur is removed */
            display: none;
            /* Changed from flex + opacity to pure display toggle */
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
            /* Activate flex when active class is present */
        }

        .modal-box {
            background: #0f0f12;
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid #333;
            width: 400px;
            max-width: 90%;
            position: relative;
            z-index: 10000;
            display: block;
            /* Ensure visibility */
        }

        /* Removed complex transforms/animations that might glitch in Firefox */

        .input-group {
            margin-bottom: 1rem;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #888;
            font-size: 0.9rem;
        }

        input,
        textarea {
            width: 100%;
            background: #050505;
            border: 1px solid #333;
            color: white;
            padding: 0.8rem;
            border-radius: 8px;
            font-family: inherit;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #666;
        }

        .btn-submit {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-submit.red {
            background: #ff0050;
            color: white;
        }

        .btn-submit.blue {
            background: #00f5ff;
            color: black;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            color: #666;
            font-size: 1.2rem;
            padding: 5px;
            line-height: 1;
        }

        .drag-hint {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(10, 10, 12, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 24px;
            border-radius: 50px;
            backdrop-filter: blur(8px);
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            animation: hintFadeIn 1s 2s forwards;
            transition: opacity 0.5s;
        }

        @keyframes hintFadeIn {
            to {
                opacity: 1;
            }
        }

        .hand-anim {
            font-size: 1.5rem;
            animation: handMove 2s infinite ease-in-out;
        }

        @keyframes handMove {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(-20px);
            }
        }

        .reactions-container {
            display: flex;
            gap: 10px;
            margin-left: auto;
            /* Push to right */
        }

        .reaction-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .reaction-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .reaction-btn.active {
            border-color: #00f5ff;
            background: rgba(0, 245, 255, 0.1);
        }
    </style>
</head>

<body>

    <div id="loading-screen"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; background: #000; display: flex; align-items: center; justify-content: center; pointer-events: none;">
        <div id="loading-info"
            style="color: rgba(255,255,255,0.5); font-family: 'Inter', sans-serif; font-size: 0.9rem; letter-spacing: 1px; text-transform: uppercase;">
            Loading...</div>
    </div>

    <!-- Motion Blur -->
    <div id="motion-blur-container"></div>

    <!-- Audio -->
    <audio id="bgAudio" loop preload="auto">
        <source src="/public/audio.flac" type="audio/flac">
        <source src="/public/song.flac" type="audio/flac">
    </audio>

    <div id="volumeControl" class="volume-control">
        <div id="volumeArrow" class="volume-arrow">
            <span>Turn up the volume</span>
            <svg width="40" height="20" viewBox="0 0 40 20" fill="none">
                <path d="M10 10l20 0m0 0l-5-5m5 5l-5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                    stroke-linejoin="round" />
            </svg>
        </div>
        <button id="imgVolumeBtn" class="btn-icon volume-btn" title="Toggle Volume">
            <svg id="iconMuted" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M11 5L6 9H2V15H6L11 19V5Z" />
                <line x1="23" y1="9" x2="17" y2="15" />
                <line x1="17" y1="9" x2="23" y2="15" />
            </svg>
            <svg id="iconSound" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" style="display: none;">
                <path d="M11 5L6 9H2V15H6L11 19V5Z" />
                <path d="M19.07 4.93C20.98 6.84 20.98 9.95 19.07 11.85" />
                <path d="M15.54 8.46C16.47 9.39 16.47 10.91 15.54 11.84" />
            </svg>
        </button>
    </div>

    <!-- Background Media -->
    <!-- Background Media -->
    <div id="video-background-container"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -5; background: #000;">
    </div>
    <script src="/public/video-slideshow.js"></script>

    <!-- View: ENTRY -->
    <div id="view-entry">
        <!-- <div class="bg-grid"></div> --> <!-- Replaced by Video -->

        <div class="main-card">
            <h1>PASTEBIN PRO</h1>

            <!-- Animated Discord Icon -->
            <div class="discord-promo" style="margin-bottom: 2.5rem; text-align: center;">
                <a href="https://discord.gg/v5kkq6nYBt" target="_blank"
                    style="display: inline-block; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);">
                    <div style="
                        width: 80px; 
                        height: 80px; 
                        background: #5865F2; 
                        border-radius: 50%; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        box-shadow: 0 0 30px rgba(88, 101, 242, 0.4);
                        animation: discordPulse 2s infinite;
                    ">
                        <svg width="45" height="45" viewBox="0 0 24 24" fill="white">
                            <path
                                d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z" />
                        </svg>
                    </div>
                </a>
            </div>

            <style>
                @keyframes discordPulse {
                    0% {
                        box-shadow: 0 0 0 0 rgba(88, 101, 242, 0.7);
                        transform: scale(1);
                    }

                    50% {
                        box-shadow: 0 0 0 15px rgba(88, 101, 242, 0);
                        transform: scale(1.05);
                    }

                    100% {
                        box-shadow: 0 0 0 0 rgba(88, 101, 242, 0);
                        transform: scale(1);
                    }
                }

                .discord-promo a:hover div {
                    background: #4752C4 !important;
                    transform: scale(1.1);
                }
            </style>

            <div class="button-container" style="position: relative; z-index: 2147483647;">
                <a href="/public" id="btnPublicAccess" class="entry-btn btn-public"
                    onclick="console.log('Public Clicked'); event.preventDefault(); navigateTo('/public');"
                    style="pointer-events: auto; display: inline-block; text-decoration: none; text-align: center; cursor: pointer; position: relative; z-index: 2147483647;">
                    Public Access
                </a>
                <a href="#" id="btnPrivateAccess" class="entry-btn btn-private"
                    onclick="console.log('Private Clicked'); openKeyModal(); return false;"
                    style="pointer-events: auto; display: inline-block; text-decoration: none; text-align: center; cursor: pointer; position: relative; z-index: 2147483647;">
                    Private Access
                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 0.5rem;">Access Key Required</div>
                </a>
            </div>

            <script>
                document.addEventListener('click', function (e) {
                    console.log('Clicked element:', e.target);
                    console.log('Coordinates:', e.clientX, e.clientY);
                }, true);
            </script>

            <a href="#" id="btnRequestAccess" class="tech-hint" onclick="openRequestModal(); return false;"
                style="z-index: 10002; position: relative; display: inline-block; pointer-events: auto; text-decoration: none;">
                Request an access key from Esco to view his private posts.
            </a>
        </div>
    </div>

    <!-- View: VIEWER (Merged) -->
    <!-- View: VIEWER (Carousel) -->
    <div id="view-viewer"
        style="display: none; position: absolute; top: 0; left: 0; width: 100%; min-height: 100vh; z-index: 20; background: #050505;">

        <!-- Gallery List -->
        <div id="listView" class="gallery">
            <ul class="cards"></ul>
            <div class="actions">
                <button class="nav-btn prev">&larr; Prev</button>
                <button class="nav-btn next">Next &rarr;</button>
            </div>

            <div id="dragHint" class="drag-hint">
                <div class="hand-anim">üëÜ</div>
                <span>Try clicking and dragging the slides for quicker viewing!</span>
            </div>
        </div>

        <!-- Detail View Overlay -->
        <div id="detailView"
            style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0a; z-index: 50; overflow-y: auto;">
            <div class="container" style="max-width: 900px; margin: 0 auto; padding: 4rem 2rem;">
                <header class="header">
                    <div class="logo">
                        <div class="logo-text">
                            <h1 style="font-size: 1.5rem;">PasteBin Pro</h1>
                            <span class="badge">Detail View</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button id="backBtn" class="btn btn-secondary">Back to Gallery</button>
                        <button id="rawBtn" class="btn btn-glass">Raw</button>
                        <button id="copyBtn" class="btn btn-secondary">Copy</button>
                    </div>
                </header>
                <main id="mainContent" style="margin-top: 2rem;">
                    <div id="detailLoading" class="state-container" style="display: none;">
                        <div class="loader"></div>
                        <p>Loading paste...</p>
                    </div>
                    <div id="notFoundState" class="state-container" style="display: none;">
                        <h2>Paste Not Found</h2>
                    </div>
                    <div id="pasteViewContent" style="display: none;">
                        <div class="paste-header">
                            <div class="paste-info">
                                <h2 id="pasteTitle">Loading...</h2>
                                <div class="paste-meta">
                                    <span class="language-tag" id="pasteLanguage">plaintext</span>
                                    <span class="meta-item" id="pasteViews">0 views</span>
                                    <span class="meta-item" id="pasteDate">Just now</span>
                                </div>
                            </div>
                            <div class="reactions-container">
                                <button class="reaction-btn" data-type="like" onclick="toggleReaction('like')">
                                    <span class="emoji">üëç</span> <span class="count" id="count-like">0</span>
                                </button>
                                <button class="reaction-btn" data-type="heart" onclick="toggleReaction('heart')">
                                    <span class="emoji">‚ù§Ô∏è</span> <span class="count" id="count-heart">0</span>
                                </button>
                                <button class="reaction-btn" data-type="star" onclick="toggleReaction('star')">
                                    <span class="emoji">‚≠ê</span> <span class="count" id="count-star">0</span>
                                </button>
                            </div>
                        </div>
                        <div class="code-container">
                            <div class="code-header">
                                <div class="code-title" id="codeTitle">code.txt</div>
                            </div>
                            <pre id="pasteContentContainer"><code id="pasteContent" class="hljs"></code></pre>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Key Entry Modal -->
    <div id="keyModal" class="modal-overlay">
        <div class="modal-box">
            <div class="close-modal" onclick="closeModals()">‚úï</div>
            <h2 style="margin-top: 0;">Enter Access Key</h2>
            <div class="input-group">
                <label>Access Key</label>
                <input type="password" id="accessKeyInput" placeholder="sk-...">
            </div>
            <button type="button" class="btn-submit blue" onclick="submitKey()">Unlock</button>
            <p style="font-size: 0.8rem; color: #666; margin-top: 1rem; text-align: center;">
                Don't have one? <a href="#" onclick="openRequestModal(); return false;" style="color: #00f5ff;">Request
                    Access</a>
            </p>
        </div>
    </div>

    <!-- Request Access Modal -->
    <div id="requestModal" class="modal-overlay">
        <!-- View 1: Auth Selection -->
        <div id="req-view-1" class="modal-box">
            <div class="close-modal" onclick="closeModals()">‚úï</div>
            <h2 style="margin-top: 0; color: #ff0050;">Request Access</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 2rem;">
                You must verify your identity before requesting a key.
            </p>
            <div class="auth-buttons">
                <button type="button" class="btn-submit auth-discord" onclick="startDiscordAuth()">
                    <svg width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px; vertical-align: bottom;">
                        <path fill="currentColor"
                            d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.419 0 1.334-.956 2.42-2.157 2.419zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.419 0 1.334-.946 2.42-2.157 2.419z" />
                    </svg>
                    Log in with Discord (Recommended)
                </button>
                <button type="button" class="btn-submit auth-manual" onclick="showManualInput()">
                    Manual Request
                </button>
            </div>
        </div>

        <!-- View 2: Manual Request Input -->
        <div id="req-view-manual" class="modal-box" style="display: none;">
            <div class="close-modal" onclick="resetRequestModal()">‚úï</div>
            <h2 style="margin-top: 0; color: #ff0050;">Manual Request</h2>
            <div class="input-group">
                <label>Your Identity (Discord User / Email)</label>
                <input type="text" id="manualIdentity" placeholder="Who are you?">
            </div>
            <div class="input-group">
                <label>Reason</label>
                <textarea id="manualReason" rows="6"
                    placeholder="To gain access, explain how you met or know Esco. In addition, please state any specialties that will help him identify you better assuming there are any :)"></textarea>
            </div>
            <p
                style="color: #888; font-size: 0.8rem; margin-bottom: 2rem; border-left: 2px solid #555; padding-left: 10px;">
                <strong>Note:</strong> You will still be required to confirm your identity later before receiving a key.
                Verification via Discord is faster and preferred.
            </p>
            <button type="button" class="btn-submit red" onclick="submitManualRequest()">Send Request</button>
        </div>

        <!-- View 4: Request Form -->
        <div id="req-view-4" class="modal-box" style="display: none;">
            <div class="close-modal" onclick="closeModals()">‚úï</div>
            <h2 style="margin-top: 0; color: #ff0050;">Submit Request</h2>
            <div class="input-group">
                <label>Verified ID</label>
                <input type="text" id="verifiedId" readonly style="opacity: 0.5;">
            </div>
            <div class="input-group">
                <label>Reason</label>
                <textarea id="reqReason" rows="6"
                    placeholder="To gain access, explain how you met or know Esco. In addition, please state any specialties that will help him identify you better assuming there are any :)"></textarea>
            </div>
            <button type="button" class="btn-submit red" onclick="submitFinalRequest()">Send Request</button>
        </div>
    </div>

    <!-- Success Popup -->
    <div id="successPopup" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
            <h2>Request Sent!</h2>
            <p style="color: #ccc; margin-bottom: 2rem;">
                Your request has been forwarded. <br>
                For faster approval, join our Discord server:
            </p>
            <a href="https://discord.gg/YAqe3UvU5E" target="_blank" class="btn-submit auth-discord"
                style="text-decoration: none; margin-bottom: 1rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" style="margin-right: 10px; vertical-align: bottom;">
                    <path fill="currentColor"
                        d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.419 0 1.334-.956 2.42-2.157 2.419zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.086 2.157 2.419 0 1.334-.946 2.42-2.157 2.419z" />
                </svg>
                Join Discord
            </a>
            <button type="button" class="btn-submit blue" onclick="window.location.reload()">Return to Home</button>
        </div>
    </div>

    <!-- Additional Styles for Auth -->
    <style>
        .auth-discord {
            background: #5865F2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .auth-discord:hover {
            background: #4752C4;
        }

        .auth-email {
            background: #333;
            color: white;
        }

        .auth-email:hover {
            background: #444;
        }
    </style>

    <script type="module">
        import { initLoadingShader } from '/public/loading-shader.js';

        // Initialize shader
        initLoadingShader('loading-screen');

        // Hide loader logic
        window.hideLoader = function () {
            const loader = document.getElementById('loading-screen');
            if (loader && !loader.classList.contains('fading')) {
                loader.classList.add('fading');
                loader.style.transition = 'opacity 1s ease';
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 1000);
            }
        };
        // Fallback
        setTimeout(window.hideLoader, 2000);
    </script>

    <script src="/shared/api.js"></script>

    <script>
        // --- 1. Audio Logic ---
        const audio = document.getElementById('bgAudio');
        const volBtn = document.getElementById('imgVolumeBtn');
        const iconMuted = document.getElementById('iconMuted');
        const iconSound = document.getElementById('iconSound');
        const arrow = document.getElementById('volumeArrow');

        let hasInteracted = false;
        audio.volume = 0.2; // Increase start volume

        function tryPlayAudio() {
            if (hasInteracted) return;

            const playPromise = audio.play();

            if (playPromise !== undefined) {
                playPromise.then(() => {
                    hasInteracted = true;
                    updateAudioIcon();
                    console.log("Audio playing");
                    // Show arrow hint
                    arrow.classList.add('visible');
                    setTimeout(() => arrow.classList.remove('visible'), 4000);
                }).catch(error => {
                    console.log("Autoplay prevented. Waiting for interaction.", error);
                });
            }
        }

        function toggleAudio() {
            if (audio.paused) {
                audio.play();
                hasInteracted = true;
            } else {
                audio.pause();
            }
            updateAudioIcon();
        }

        function updateAudioIcon() {
            if (!audio.paused) {
                iconMuted.style.display = 'none';
                iconSound.style.display = 'block';
                volBtn.classList.add('active-volume');
            } else {
                iconMuted.style.display = 'block';
                iconSound.style.display = 'none';
                volBtn.classList.remove('active-volume');
            }
        }

        volBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleAudio();
        });

        // Try playing immediately
        tryPlayAudio();

        // Global interaction listeners - aggressive
        const interactEvents = ['click', 'keydown', 'touchstart', 'mousemove', 'scroll'];
        interactEvents.forEach(evt =>
            window.addEventListener(evt, tryPlayAudio, { once: true, capture: true })
        );


        // --- 2. SPA Navigation ---

        // Handle Back/Forward
        window.addEventListener('popstate', handleRoute);
        // Handle Initial Load
        document.addEventListener('DOMContentLoaded', handleRoute);

        function navigateTo(path) {
            console.log("Navigating to:", path);
            window.history.pushState({}, '', path);
            handleRoute();
        }

        function handleRoute() {
            const path = window.location.pathname;

            // Ensure audio is trying to play on route change (interaction happened)
            if (audio.paused && hasInteracted) {
                audio.play().catch(e => console.log('Resume play failed', e));
                updateAudioIcon();
            }

            // Entry Page
            if (path === '/' || path === '/index.html') {
                document.getElementById('view-entry').style.display = 'flex';
                document.getElementById('view-viewer').style.display = 'none';
                document.body.style.overflow = 'hidden'; // Lock scroll on entry
            }
            // Public Viewer
            else if (path.startsWith('/public') || path.startsWith('/v/')) {
                document.getElementById('view-entry').style.display = 'none';
                document.getElementById('view-viewer').style.display = 'block';
                document.body.style.overflow = 'auto'; // Allow scroll

                if (path.startsWith('/v/')) {
                    const id = path.split('/')[2];
                    showDetail(id);
                } else {
                    showList();
                }
            }
        }


        // --- 3. Viewer Logic ---
        const storage = new PasteStorage();
        const listView = document.getElementById('listView');
        const detailView = document.getElementById('detailView');
        const pasteListContainer = document.getElementById('pasteList');
        const detailLoading = document.getElementById('detailLoading');
        const notFoundState = document.getElementById('notFoundState');
        const pasteViewContent = document.getElementById('pasteViewContent');

        // Elements for detail
        const pasteTitle = document.getElementById('pasteTitle');
        const pasteLanguage = document.getElementById('pasteLanguage');
        const pasteViews = document.getElementById('pasteViews');
        const pasteDate = document.getElementById('pasteDate');
        const pasteContent = document.getElementById('pasteContent');

        async function showList() {
            detailView.style.display = 'none';
            listView.style.display = 'block';
            await loadPastes();
        }

        async function loadPastes() {
            try {
                const headers = { 'Content-Type': 'application/json' };
                const key = localStorage.getItem('private_access_key');
                if (key) headers['x-access-key'] = key;

                const res = await fetch('/api/pastes/public-list', { headers });
                const pastes = await res.json();

                const cardsContainer = document.querySelector('.cards');
                if (!cardsContainer) {
                    console.error('Cards container not found');
                    return;
                }

                if (pastes.length === 0) {
                    cardsContainer.innerHTML = '<li style="display:flex; justify-content:center; align-items:center; background:none; border:none; box-shadow:none;"><h3>No Pastes Found</h3></li>';
                    return;
                }

                // Populate Cards
                cardsContainer.innerHTML = pastes.map(p => `
                    <li onclick="showDetail('${p.id}')" class="${p.isPrivate ? 'private-card' : ''}">
                        <h3>${p.title || 'Untitled'}</h3>
                        <div class="card-meta">
                            <span>${p.language}</span>
                            ${p.isPrivate ? '<span>üîí Private</span>' : ''}
                        </div>
                        <div class="card-preview">${p.content ? p.content.substring(0, 200).replace(/</g, '&lt;') : ''}</div>
                    </li>
                `).join('');

                // Initialize GSAP Loop
                setTimeout(() => {
                    if (window.ScrollTrigger) ScrollTrigger.getAll().forEach(t => t.kill());
                    initCarousel();
                }, 100);

            } catch (e) {
                console.error(e);
            }
        }

        function initCarousel() {
            gsap.registerPlugin(ScrollTrigger, Draggable);

            // Cleanup old triggers/draggables
            ScrollTrigger.getAll().forEach(t => t.kill());
            Draggable.get(".cards")?.kill(); // Kill old draggable if attached to cards

            let iteration = 0;

            // Initial state
            gsap.set('.cards li', { xPercent: 400, opacity: 0, scale: 0 });

            const spacing = 0.17, // Increased spacing for better separation
                snapTime = gsap.utils.snap(spacing),
                cardsItems = gsap.utils.toArray('.cards li'),
                // Animate Function: Tighter movement (250% instead of 400%) for controlled landing
                animateFunc = element => {
                    const tl = gsap.timeline();
                    tl.fromTo(element, { scale: 0.2, opacity: 0 }, { scale: 1, opacity: 1, zIndex: 100, duration: 0.5, yoyo: true, repeat: 1, ease: "power1.in", immediateRender: false })
                        .fromTo(element, { xPercent: 250 }, { xPercent: -250, duration: 1, ease: "none", immediateRender: false }, 0);
                    return tl;
                },
                seamlessLoop = buildSeamlessLoop(cardsItems, spacing, animateFunc),
                playhead = { offset: 0 },
                wrapTime = gsap.utils.wrap(0, seamlessLoop.duration()),
                scrub = gsap.to(playhead, {
                    offset: 0,
                    onUpdate() {
                        seamlessLoop.time(wrapTime(playhead.offset));
                    },
                    duration: 0.7, // Smoother scrub
                    ease: "power3",
                    paused: true
                }),
                trigger = ScrollTrigger.create({
                    start: 0,
                    onUpdate(self) {
                        let scroll = self.scroll();
                        if (scroll > self.end - 1) {
                            wrap(1, 2);
                        } else if (scroll < 1 && self.direction < 0) {
                            wrap(-1, self.end - 2);
                        } else {
                            scrub.vars.offset = (iteration + self.progress) * seamlessLoop.duration();
                            scrub.invalidate().restart();
                        }
                    },
                    end: "+=3000",
                    pin: ".gallery"
                }),
                progressToScroll = progress => gsap.utils.clamp(1, trigger.end - 1, gsap.utils.wrap(0, 1, progress) * trigger.end),
                wrap = (iterationDelta, scrollTo) => {
                    iteration += iterationDelta;
                    trigger.scroll(scrollTo);
                    trigger.update();
                };

            ScrollTrigger.addEventListener("scrollEnd", () => scrollToOffset(scrub.vars.offset));

            function scrollToOffset(offset) {
                let snappedTime = snapTime(offset),
                    progress = (snappedTime - seamlessLoop.duration() * iteration) / seamlessLoop.duration(),
                    scroll = progressToScroll(progress);
                if (progress >= 1 || progress < 0) {
                    return wrap(Math.floor(progress), scroll);
                }
                trigger.scroll(scroll);
            }

            // Navigation Buttons
            const nextBtn = document.querySelector(".next");
            const prevBtn = document.querySelector(".prev");
            if (nextBtn) nextBtn.replaceWith(nextBtn.cloneNode(true));
            if (prevBtn) prevBtn.replaceWith(prevBtn.cloneNode(true));
            document.querySelector(".next").addEventListener("click", () => scrollToOffset(scrub.vars.offset + spacing));
            document.querySelector(".prev").addEventListener("click", () => scrollToOffset(scrub.vars.offset - spacing));

            // Draggable directly on Container, proxying to virtual value
            const proxy = document.createElement("div");
            Draggable.create(proxy, {
                type: "x",
                trigger: ".cards", // Drag the container directly
                inertia: true,
                onPress() {
                    const hint = document.getElementById('dragHint');
                    if (hint) hint.style.opacity = '0';
                    this.startOffset = scrub.vars.offset;
                },
                onDrag() {
                    scrub.vars.offset = this.startOffset + (this.startX - this.x) * 0.002; // Adjusted sensitivity
                    scrub.invalidate().restart();
                },
                onDragEnd() {
                    scrollToOffset(scrub.vars.offset);
                },
                onClick(e) {
                    // Handle Click reliably
                    const target = e.target.closest('li');
                    if (target) {
                        // Extract ID from onclick attribute since we can't easily access dataset here if not set
                        const clickStr = target.getAttribute('onclick');
                        if (clickStr && clickStr.includes('showDetail')) {
                            const match = clickStr.match(/'([^']+)'/);
                            if (match) showDetail(match[1]);
                        }
                    }
                }
            });
        }

        function buildSeamlessLoop(items, spacing, animateFunc) {
            let overlap = Math.ceil(1 / spacing),
                startTime = items.length * spacing + 0.5,
                loopTime = (items.length + overlap) * spacing + 1,
                rawSequence = gsap.timeline({ paused: true }),
                seamlessLoop = gsap.timeline({
                    paused: true,
                    repeat: -1,
                    onRepeat() {
                        this._time === this._dur && (this._tTime += this._dur - 0.01);
                    }
                }),
                l = items.length + overlap * 2,
                time, i, index;

            for (i = 0; i < l; i++) {
                index = i % items.length;
                time = i * spacing;
                rawSequence.add(animateFunc(items[index]), time);
                i <= items.length && seamlessLoop.add("label" + i, time);
            }

            rawSequence.time(startTime);
            seamlessLoop.to(rawSequence, {
                time: loopTime,
                duration: loopTime - startTime,
                ease: "none"
            }).fromTo(rawSequence, { time: overlap * spacing + 1 }, {
                time: startTime,
                duration: startTime - (overlap * spacing + 1),
                immediateRender: false,
                ease: "none"
            });
            return seamlessLoop;
        }

        function renderPasteItem(p) { return ''; } // Deprecated helper

        async function showDetail(id) {
            // Disable ScrollTrigger/Draggable to prevent carousel hijacking scroll in Detail View
            if (window.ScrollTrigger) ScrollTrigger.getAll().forEach(t => t.disable());
            if (window.Draggable) Draggable.get(".cards")?.disable();

            listView.style.display = 'none';
            detailView.style.display = 'block';

            detailLoading.style.display = 'flex';
            notFoundState.style.display = 'none';
            pasteViewContent.style.display = 'none';

            try {
                let paste = null;
                try {
                    paste = await storage.getPaste(id);
                } catch (e) {
                    if (e.message.includes('401')) {
                        const pwd = prompt('üîí Password required:');
                        if (!pwd) throw new Error('Cancelled');
                        paste = await storage.getPaste(id, true, pwd);
                    } else {
                        throw e;
                    }
                }

                if (!paste) throw new Error('Not found');

                renderPasteDetail(paste);
                detailLoading.style.display = 'none';
                pasteViewContent.style.display = 'block';

            } catch (err) {
                console.error(err);
                detailLoading.style.display = 'none';
                if (err.message !== 'Cancelled') notFoundState.style.display = 'flex';
            }
        }

        function renderPasteDetail(paste) {
            pasteTitle.textContent = paste.title || 'Untitled';
            pasteLanguage.textContent = paste.language;
            pasteViews.textContent = `${paste.views} views`;
            pasteDate.textContent = new Date(paste.createdAt).toLocaleString();

            pasteContent.className = `hljs language-${paste.language}`;
            if (paste.language === 'markdown') {
                pasteContent.innerHTML = marked.parse(paste.content);
            } else {
                pasteContent.textContent = paste.content;
                hljs.highlightElement(pasteContent);
            }
            window.currentViewedPaste = paste;

            // Reactions
            if (paste.reactions) {
                document.getElementById('count-like').textContent = paste.reactions.like || 0;
                document.getElementById('count-heart').textContent = paste.reactions.heart || 0;
                document.getElementById('count-star').textContent = paste.reactions.star || 0;
            }

            // Cleanup active states (simple reset for now)
            document.querySelectorAll('.reaction-btn').forEach(b => b.classList.remove('active'));
        }

        window.toggleReaction = async function (type) {
            if (!window.currentViewedPaste) return;
            const btn = document.querySelector(`.reaction-btn[data-type="${type}"]`);
            if (!btn) return;

            // Optimistic Update
            const countEl = btn.querySelector('.count');
            let current = parseInt(countEl.textContent) || 0;
            const wasActive = btn.classList.contains('active');

            // Toggle visual state immediately
            if (wasActive) {
                // Not supported visually yet without tracking 'my' reactions perfectly, 
                // but for now we assume they can just click.
                // Actually, let's just animate.
            }

            try {
                const res = await fetch(`/api/pastes/${window.currentViewedPaste.id}/react`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type })
                });
                const data = await res.json();

                if (data.success) {
                    if (data.action === 'added') {
                        countEl.textContent = current + 1;
                        btn.classList.add('active');
                    } else if (data.action === 'removed') {
                        countEl.textContent = Math.max(0, current - 1);
                        btn.classList.remove('active');
                    }
                } else if (data.authRequired) {
                    // Not logged in -> Prompt Discord Login
                    alert("You must log in with Discord to react/vote.");

                    // Reset modal state to just show Discord button and "Login" title
                    closeModals();
                    resetRequestModal();

                    // Small hack to re-purpose the Request Modal for just Login
                    const title = document.querySelector('#req-view-1 h2');
                    if (title) title.textContent = "Login Required";
                    const subtitle = document.querySelector('#req-view-1 p');
                    if (subtitle) subtitle.textContent = "Please log in with Discord to continue.";

                    // Hide Manual button if we only want Discord for reactions
                    const manualBtn = document.querySelector('.auth-manual');
                    if (manualBtn) manualBtn.style.display = 'none';

                    document.getElementById('requestModal').classList.add('active');
                }
            } catch (e) {
                console.error("Reaction failed", e);
            }
        }

        // Viewer Buttons
        document.getElementById('backBtn').addEventListener('click', () => navigateTo('/public'));
        document.getElementById('copyBtn').addEventListener('click', () => {
            if (window.currentViewedPaste) navigator.clipboard.writeText(window.currentViewedPaste.content);
        });
        document.getElementById('rawBtn').addEventListener('click', () => {
            if (window.currentViewedPaste) {
                const win = window.open();
                win.document.write(`<pre>${window.currentViewedPaste.content}</pre>`);
            }
        });


        // --- 4. Auth & Modal Logic (Restored) ---
        let currentEmail = '';
        let authMethod = '';

        window.openKeyModal = function () {
            closeModals();
            document.getElementById('keyModal').classList.add('active');
        }

        window.openRequestModal = function () {
            console.log("Opening request modal");
            closeModals();
            resetRequestModal();
            document.getElementById('requestModal').classList.add('active');
        }

        window.closeModals = function () {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
        }

        window.switchView = function (id) {
            document.querySelectorAll('#requestModal .modal-box').forEach(el => el.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        window.resetRequestModal = function () {
            switchView('req-view-1');
            document.getElementById('manualIdentity').value = '';
            document.getElementById('manualReason').value = '';
            document.getElementById('reqReason').value = '';
        }

        window.startDiscordAuth = function () {
            const width = 500;
            const height = 800;
            const left = (window.screen.width / 2) - (width / 2);
            const top = (window.screen.height / 2) - (height / 2);

            const popup = window.open('/api/access/auth/discord', 'Discord Auth', `width=${width},height=${height},top=${top},left=${left}`);

            window.addEventListener('message', function onMessage(e) {
                if (e.data.type === 'DISCORD_VERIFIED') {
                    window.removeEventListener('message', onMessage);

                    // FOUND AUTO-KEY?
                    if (e.data.existingKey) {
                        localStorage.setItem('private_access_key', e.data.existingKey);
                        closeModals();
                        // Show quick success visual
                        const hint = document.querySelector('.tech-hint');
                        if (hint) hint.innerHTML = "<span style='color:#00ff88'>ACCESS GRANTED. WELCOME BACK.</span>";
                        setTimeout(() => navigateTo('/public'), 800);
                        return;
                    }

                    currentEmail = e.data.id;
                    authMethod = 'Discord';
                    document.getElementById('verifiedId').value = currentEmail;
                    switchView('req-view-4');
                }
            });
        }

        window.showManualInput = function () {
            switchView('req-view-manual');
        }

        window.submitManualRequest = async function () {
            const contact = document.getElementById('manualIdentity').value;
            const reason = document.getElementById('manualReason').value;
            const btn = document.querySelector('#req-view-manual .btn-submit');

            if (!contact || !reason) return alert('Please fill in all fields.');

            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const res = await fetch('/api/access/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contact, reason, method: 'Manual' })
                });
                const data = await res.json();

                if (data.success) {
                    closeModals();
                    document.getElementById('successPopup').classList.add('active');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Connection error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Request';
            }
        }

        window.submitFinalRequest = async function () {
            const reason = document.getElementById('reqReason').value;
            const btn = document.querySelector('#req-view-4 .btn-submit');

            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const res = await fetch('/api/access/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contact: currentEmail, reason, method: authMethod })
                });
                const data = await res.json();

                if (data.success) {
                    closeModals();
                    document.getElementById('successPopup').classList.add('active');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Connection error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Request';
            }
        }

        window.submitKey = async function () {
            const key = document.getElementById('accessKeyInput').value.trim();
            const btn = document.querySelector('#keyModal .btn-submit');
            if (!key) return alert('Enter a key.');
            btn.disabled = true;
            btn.textContent = 'Verifying...';
            try {
                const res = await fetch('/api/access/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key })
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('private_access_key', data.key);
                    closeModals();
                    navigateTo('/public'); // Changed from window.location.href to SPA nav
                } else {
                    alert(data.error || 'Invalid key.');
                }
            } catch (e) {
                alert('Verification failed.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Unlock';
            }
        }

        // Explicit Event Listeners for Entry Buttons
        document.addEventListener('DOMContentLoaded', () => {
            const btnPublic = document.getElementById('btnPublicAccess');
            const btnPrivate = document.getElementById('btnPrivateAccess');
            const btnRequest = document.getElementById('btnRequestAccess');

            if (btnPublic) {
                btnPublic.onclick = null; // Clear inline just in case
                btnPublic.addEventListener('click', () => navigateTo('/public'));
            }

            if (btnPrivate) {
                btnPrivate.onclick = null;
                btnPrivate.addEventListener('click', (e) => {
                    e.preventDefault();
                    openKeyModal();
                });
            }

            if (btnRequest) {
                btnRequest.onclick = null;
                btnRequest.addEventListener('click', (e) => {
                    console.log("Request Clicked via Listener");
                    e.preventDefault();
                    e.stopPropagation();
                    openRequestModal();
                });
            }
        });

        // Glitch effect on hint
        const hint = document.querySelector('.tech-hint');
        if (hint) {
            setInterval(() => {
                if (Math.random() > 0.95) {
                    hint.style.opacity = 0.5;
                    setTimeout(() => hint.style.opacity = 0.8, 50);
                }
            }, 100);
        }
    </script>
    <script>
        window.submitKey = async function () {
            const key = document.getElementById('accessKeyInput').value.trim();
            const btn = document.querySelector('#keyModal .btn-submit');
            if (!key) return alert('Enter a key.');

            btn.disabled = true;
            btn.textContent = 'Verifying...';
            try {
                const res = await fetch('/api/access/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key })
                });
                const data = await res.json();
                if (data.success) {
                    localStorage.setItem('private_access_key', data.key);
                    closeModals();
                    navigateTo('/public');
                } else {
                    alert(data.error || 'Invalid key.');
                }
            } catch (e) {
                alert('Verification failed.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Unlock';
            }
        };

        async function checkStoredKey() {
            const storedKey = localStorage.getItem('private_access_key');
            if (storedKey) {
                try {
                    const res = await fetch('/api/access/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key: storedKey })
                    });
                    const data = await res.json();

                    if (data.success) {
                        console.log("‚úÖ Auto-unlocked with stored key");
                        const entryView = document.getElementById('view-entry');
                        if (entryView && entryView.style.display !== 'none') {
                            navigateTo('/public');
                        }
                    } else {
                        console.warn("Stored key invalid/expired");
                        localStorage.removeItem('private_access_key');
                    }
                } catch (e) {
                    console.error("Auto-check failed", e);
                }
            }
        }
        document.addEventListener('DOMContentLoaded', checkStoredKey);
    </script>
</body>

</html>